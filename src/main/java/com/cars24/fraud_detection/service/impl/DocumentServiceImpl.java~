package com.cars24.fraud_detection.service.impl;

import com.cars24.fraud_detection.data.dao.DocumentDao;
import com.cars24.fraud_detection.data.entity.DocumentEntity;
import com.cars24.fraud_detection.data.request.DocumentRequest;
import com.cars24.fraud_detection.data.response.DocumentResponse;
import com.cars24.fraud_detection.exception.DocumentProcessingException;
import com.cars24.fraud_detection.service.DocumentService;
import com.cars24.fraud_detection.workflow.WorkflowInitiator;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class DocumentServiceImpl implements DocumentService {

    private final DocumentDao documentDao;
    private final WorkflowInitiator workflowInitiator;

    @Value("${document.storage.path}")
    private String storagePath;

    @Override
    public DocumentResponse processDocument(DocumentRequest request) {
        try {
            log.info("üîç Processing document for user: {}", request.getUserId());

            // ‚úÖ Step 1: Run workflow (OCR, Validation, Quality, Forgery Detection)
            DocumentResponse response = workflowInitiator.processDocument(request);
            log.info("‚úÖ Workflow execution completed for file: {}", request.getFileName());

            // ‚úÖ Step 2: Use the actual stored document path from workflow
            String documentFilePath = response.getFilePath();  // Fetch from response

            // ‚úÖ Step 3: Save document details to database
            DocumentEntity entity = DocumentEntity.builder()
                    .userId(request.getUserId())
                    .fileName(request.getFileName())
                    .filePath(documentFilePath) // Using actual stored path
                    .status(response.isValid() ? "COMPLETED" : "FAILED")
                    .remarks(response.getRemarks())
                    .ocrResults(response.getOcrResults() != null ? response.getOcrResults() : Map.of())  // ‚úÖ Handle null safely
                    .qualityResults(response.getQualityResults() != null ? response.getQualityResults() : Map.of())
                    .forgeryResults(response.getForgeryResults() != null ? response.getForgeryResults() : Map.of())
                    .validationResults(response.getValidationResults() != null ? response.getValidationResults() : Map.of())
                    .finalRiskScore(response.getFinalRiskScore())
                    .riskLevel(response.getRiskLevel())
                    .decision(response.getDecision())
                    .nextSteps(response.getNextSteps())
                    .build();

            documentDao.saveDocument(entity);
            log.info("‚úÖ Document saved successfully in database: {} (Status: {})", request.getFileName(), entity.getStatus());

            return response;

        } catch (Exception e) {
            log.error("‚ùå Error processing document: {}", e.getMessage(), e);
            throw new DocumentProcessingException("Failed to process document. Please try again.");
        }
    }

    @Override
    public DocumentResponse getDocumentById(String documentId) {
        log.info("üîç Fetching document by ID: {}", documentId);

        DocumentEntity documentEntity = documentDao.getDocumentById(documentId)
                .orElseThrow(() -> {
                    log.warn("‚ùå Document not found: {}", documentId);
                    return new DocumentProcessingException("Document not found");
                });

        log.info("‚úÖ Document fetched successfully: {}", documentId);
        return documentEntity.toResponse();
    }
}
